specVersion: "0.8"
id: terraform
version: 0.0.1
name: Terraform
description: "Workflow that provisions infrastructure using Terraform Cloud API"
start: GetUploadURL
extensions:
  - extensionid: workflow-uri-definitions
    definitions:
      notifications: "https://raw.githubusercontent.com/rhdhorchestrator/serverless-workflows/main/workflows/shared/specs/notifications-openapi.yaml"
annotations:
  - "workflow-type/infrastructure"
dataInputSchema: schemas/terraform-input-schema.json
functions:
  - name: getUploadURL
    operation: specs/terraform-openapi.yaml#listConfigurationVersions
  - name: getWorkspaceInfo
    operation: specs/terraform-openapi.yaml#getWorkspaceInfo
  - name: getLatestTerraformRun
    operation: specs/terraform-openapi.yaml#getRun
  - name: HandleTerraformConfigUpload
    type: custom
    operation: "service:java:io.janus.workflow.terraform.HandleTerraformConfigUpload::UploadTerraformConfig"
  - name: logInfo
    type: custom
    operation: "sysout:INFO"
  - name: extractURL
    type: expression
    operation: '.configurationVersions.data.attributes."upload-url" | split("/object/") | .[1]'
  - name: createNotification
    operation: notifications#createNotification
states:
  - name: GetUploadURL
    type: operation
    actions:
      - functionRef:
          refName: getUploadURL
          arguments:
            workspaceId: .workspaceId
            data:
              type: "configuration-versions"
        actionDataFilter:
          toStateData: .configurationVersions
      - functionRef:
          refName: logInfo
          arguments:
            message: .configurationVersions
      - functionRef:
          refName: extractURL
        actionDataFilter:
          toStateData: .extractedURL
    transition: HandleTerraformConfigUpload

  - name: HandleTerraformConfigUpload
    type: operation
    actions:
      - name: HandleTerraformConfigUpload
        functionRef:
          refName: HandleTerraformConfigUpload
          arguments:
            sourceUrl: .sourceUrl
            targetUri: .configurationVersions.data.attributes."upload-url"
    transition: GetTerraformRun

  - name: GetTerraformRun
    type: operation
    actions:
      - functionRef:
          refName: logInfo
          arguments:
            message: '"Sleeping before checking the run ID "'
        sleep:
          after: PT15S
      - functionRef:
          refName: getWorkspaceInfo
          arguments:
            workspaceId: .workspaceId
        actionDataFilter:
          toStateData: .workspaceInfo

      - functionRef:
          refName: getLatestTerraformRun
          arguments:
            runId: .workspaceInfo.data.relationships."latest-run".data.id
        actionDataFilter:
          toStateData: .terraformRun
    transition: IsRunDone

  - name: IsRunDone
    type: switch
    dataConditions:
      - condition: (.terraformRun.data.attributes.status == "applied")
        transition:
          nextState: SendSuccessNotification
      - condition: (.terraformRun.data.attributes.status == "discarded")
        transition:
          nextState: SendFailureNotification
      - condition: (.terraformRun.data.attributes.status == "canceled")
        transition:
          nextState: SendFailureNotification
    defaultCondition:
      transition: GetTerraformRun

  - name: SendFailureNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: ['user:default/guest']
            payload:
              title: '"Terraform Workflow Failed"'
              description: '"Terraform job workflow id: " + $WORKFLOW.instanceId " has failed to provision the Terraform configurations."'
              scope: "Terraform Job Workflow"
              topic: "Terraform Job Workflow"
              link: .launchedJob.outputUrl
    end: true
  - name: SendSuccessNotification
    type: operation
    actions:
      - functionRef:
          refName: createNotification
          arguments:
            recipients:
              type: "entity"
              entityRef: ['user:default/guest']
            payload:
              title: '"Terraform Workflow Succeeded"'
              description: '"Terraform job workflow id: " + $WORKFLOW.instanceId + " has successfully applied the Terraform Config."'
              scope: "Terraform Job Workflow"
              topic: "Terraform Job Workflow"
              link: .launchedJob.outputUrl
    end: true