specVersion: "0.8"
id: servicenow-escalation
name: ServiceNow Change Request escalation
annotations:
  - "workflow-type/infrastructure"
version: 0.0.1
timeouts:
  workflowExecTimeout: PT24H
start: CreateChangeRequest
dataInputSchema: servicenow-escalation-schema.json
functions:
  - name: createChangeRequest
    operation: specs/servicenow.yaml#createChangeRequest
  - name: getChangeRequest
    operation: specs/servicenow.yaml#getChangeRequest
  - name: logInfo
    type: custom
    operation: "sysout:INFO"
states:
  - name: CreateChangeRequest
    type: operation
    actions:
      - functionRef:
          refName: createChangeRequest
          arguments:
            description: ".description"
            short_description: ".short_description"
            comments: ".comments"
            state: ".state"
            assigned_to: ".assigned_to"
            additional_assignee_list: ".additional_assignee_list"
            assignment_group: ".assignment_group"
        actionDataFilter:
          toStateData: .createdChangeRequest
    transition: GetChangeRequest
  - name: GetChangeRequest
    type: operation
    actions:
      - name: "SleepBeforeChecking"
        functionRef:
          refName: "logInfo"
          arguments:
            message: "\"Sleeping before checking the change request \\(.createdChangeRequest.result)\""
        sleep:
          after: PT30S
      - name: "getChangeRequest" 
        functionRef:
          refName: getChangeRequest
          arguments:
            sys_id: ".createdChangeRequest.result.sys_id"
        actionDataFilter:
          toStateData: .readChangeRequest
    transition: IsApproved
  - name: IsApproved
    type: switch
    dataConditions:
      - condition: (.readChangeRequest.result.state == "-5")
        transition:
          nextState: RemindManagerToApprove
      - condition: (.readChangeRequest.result.state != "-5")
        transition:
          nextState: ThankAndTerminate
    defaultCondition:
      transition: GetChangeRequest
  - name: RemindManagerToApprove
    type: operation
    actions:
      - name: "RemindManagerToApprove"
        functionRef:
          refName: "logInfo"
          arguments:
            message: "\"Manager, please approve this change request \\(.createdChangeRequest.result.number)\""
    transition: GetChangeRequest
  - name: ThankAndTerminate
    type: operation
    actions:
      - name: "ThankAndTerminate"
        functionRef:
          refName: "logInfo"
          arguments:
            message: "\"Thanks Manager for approving this change request \\(.createdChangeRequest.result.number)\""
    end: true